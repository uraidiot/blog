---
title: 基于个人理解的事件循环
date: 2020-06-28 14:10:43
tags:
---

### 1.1 什么是事件循环

客户端`Web`应用的生命周期主要包括:页面构建,事件处理.其中事件处理主要通过事件循环(`Event Loop`)这种机制进行处理.

### 1.2 深入事件循环

#### 1.2.1 事件队列和任务

事件循环中包含了两个事件队列用于分别存放不同类别的任务

任务则可以分为两类: 
- 宏任务
- 微任务

宏任务主要包括: 

- 创建文档对象
- 解析HTML
- 执行主线(或全局)JS
- 更改当前URL
- 各种其他事件(页面加载/输入/网络事件和定时器事件等)

*注: 执行主线JS是一个任务*

微任务主要包括:

- Promise回调函数
- DOM发生变化等

#### 1.2.2 事件循环的基本原则

事件循环基于两个基本原则: 

- 一次处理一个任务

- 一个任务开始后直到运行完成,不会被其他任务中断

单次循环基本流程如下:

```flow
st=>start: Start
cond1=>condition: 宏队列是否为空?
o1=>operation: 执行一项宏任务
cond2=>condition: 微任务队列是否为空?
o2=>operation: 执行一项微任务
cond3=>condition: 是否需要重新渲染?
o3=>operation: 重新渲染
e=>end: End

st->cond1
cond1(no)->o1->cond2
cond1(yes)->cond2
cond2(no)->o2->cond2
cond2(yes)->cond3
cond3(no)->e
cond3(yes)->o3->e
```

在一次迭代中,事件循环首先检查宏任务队列,如果宏任务等待,则立即开始执行宏任务.直到该任务运行完成,事件循环将移动到微任务队列,并将微任务队列中所有任务执行完毕.完成之后,检查UI视图是否更新.之后再重新进入下一次迭代.

单次事件循环中,最多处理一个宏任务(其余在队列中等待),而所有微任务都将被处理.

### 2.1 具体示例

```
console.log(1);

function doSomething() {
    console.log(2);
};

setTimeout(() => {
    console.log(3);
}, 1000);

Promise.resolve().then(() => { console.log(4) });

doSomething();

// 1, 2, 4, 3

```

第一步全局`js`是一个宏任务,开始执行.首先输出1,

第二步定义一个`doSomething`函数,

第三步执行`setTimeout`,它的回调属于一个新的宏任务,并放入宏任务队列中.

第四步执行`Promise`在`then`函数中注册了一个回调,属于微任务,放入微任务队列中

第五步执行`doSomething`函数,输出2

第六步完成执行全局`js`这个宏任务,开始检查微任务队列,并全部执行,输出4

第七步进行下一次事件循环迭代.执行`setTimeout`回调,输出3
